<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { 
        getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
        onAuthStateChanged, signOut, sendPasswordResetEmail,
        GoogleAuthProvider, signInWithPopup 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, getDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBsnPYplE-NY22jiqCk6l8ecrTQRLD1XsU",
        authDomain: "jetasofjs-1138.firebaseapp.com",
        projectId: "jetasofjs-1138",
        storageBucket: "jetasofjs-1138.appspot.com",
        messagingSenderId: "200797115936",
        appId: "1:200797115936:web:c342a00b0f10880cb8ce45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let isSignUpMode = false;

    // UI Helpers
    function showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMsg').textContent = msg;
        toast.style.transform = 'translateY(0)';
        setTimeout(() => { toast.style.transform = 'translateY(-100px)'; }, 4000);
    }

    // Tab Logic: Switches between Sign In and Sign Up
    const tabSignin = document.getElementById('tabSignin');
    const tabSignup = document.getElementById('tabSignup');
    const signupFields = document.getElementById('signupFields');
    const authBtn = document.getElementById('authBtn');

    tabSignin.onclick = () => {
        isSignUpMode = false;
        signupFields.classList.add('hidden');
        authBtn.textContent = "Sign In";
        tabSignin.className = "flex-1 pb-3 font-bold text-blue-600 border-b-2 border-blue-600";
        tabSignup.className = "flex-1 pb-3 font-bold text-gray-400";
    };

    tabSignup.onclick = () => {
        isSignUpMode = true;
        signupFields.classList.remove('hidden');
        authBtn.textContent = "Create Account";
        tabSignup.className = "flex-1 pb-3 font-bold text-blue-600 border-b-2 border-blue-600";
        tabSignin.className = "flex-1 pb-3 font-bold text-gray-400";
    };

    // Main Auth Button (Email/Password)
    authBtn.onclick = async () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (!email || !password) return showToast("Enter email and password");

        try {
            if (isSignUpMode) {
                // SIGN UP PATH: Fails if user already exists
                const fullName = document.getElementById('fullName').value.trim();
                const type = document.getElementById('userType').value;
                if (!fullName) return showToast("Please enter Full Name for Sign Up");
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    fullName, email, type, createdAt: serverTimestamp()
                });
                showToast("Account Created Successfully!");
            } else {
                // SIGN IN PATH: Fails if user does not exist
                await signInWithEmailAndPassword(auth, email, password);
            }
        } catch (err) {
            if (err.code === 'auth/user-not-found') {
                showToast("No account found with this email. Please click 'Sign Up' first!");
            } else if (err.code === 'auth/wrong-password') {
                showToast("Incorrect password. Try again or reset it.");
            } else {
                showToast(err.message);
            }
        }
    };

    // Google Sign-In Logic
    document.getElementById('googleBtn').onclick = async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            // Optional: Save Google user to Firestore if new
            const user = result.user;
            await setDoc(doc(db, "users", user.uid), {
                uid: user.uid,
                fullName: user.displayName,
                email: user.email,
                type: "Consultant", // Default for Google users
                createdAt: serverTimestamp()
            }, { merge: true });
        } catch (err) {
            showToast("Google Error: " + err.message);
        }
    };

    // Forgot Password
    document.getElementById('forgotBtn').onclick = async () => {
        const email = document.getElementById('email').value.trim();
        if (!email) return showToast("Enter your email above first!");
        try {
            await sendPasswordResetEmail(auth, email);
            showToast("Reset link sent to " + email);
        } catch (err) {
            showToast(err.message);
        }
    };

    // Session Handling
    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
        } else {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }
    });

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>
